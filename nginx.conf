# CubeOS Website — Content negotiation + static serving
# Base image handles TLS on 8443, security headers, CSP

server {
    listen 8443 ssl;
    server_name get.cubeos.app;

    root /usr/share/nginx/html;
    index index.html;

    # Health check endpoint for HAProxy
    location = /healthz {
        access_log off;
        return 200 "ok\n";
        default_type text/plain;
    }

    # Content negotiation — curl gets install script, browsers get website
    location = / {
        if ($http_user_agent ~* "^(curl|Wget|wget|HTTPie|PowerShell)") {
            rewrite ^ /install.sh last;
        }
        try_files $uri $uri/ /index.html;
    }

    # Serve install.sh as plain text with short cache
    location = /install.sh {
        default_type text/plain;
        add_header Cache-Control "public, max-age=300";
        add_header X-Content-Type-Options "nosniff";
    }

    # Channel metadata — JSON with short cache
    location /channels/ {
        default_type application/json;
        add_header Cache-Control "public, max-age=300";
        add_header Access-Control-Allow-Origin "*";
    }

    # Static assets — long cache
    location ~* \.(css|js|svg|png|ico|woff2?)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # All other pages
    location / {
        try_files $uri $uri/ =404;
    }
}
